name: CI

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

jobs:
  lint:
    name: Lint (ruff check)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e .[dev]

      - name: Run ruff lint
        run: ruff check src tests

  format:
    name: Format check (ruff format)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e .[dev]

      - name: Check formatting
        run: ruff format --check src tests

  typecheck:
    name: Type check (mypy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e .[dev]

      - name: Run mypy
        run: mypy src

  test:
    name: Test (pytest + coverage)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e .[dev]

      - name: Run pytest with coverage
        run: >
          pytest
          --cov=src/devr
          --cov-branch
          --cov-report=term-missing
          --cov-fail-under=85

  test-py39:
    name: Test (pytest on Python 3.9)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.9"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e .[dev]

      - name: Run pytest
        run: pytest

  test-py314:
    name: Test (pytest on Python 3.14)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.14"
          allow-prereleases: true
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e .[dev]

      - name: Run pytest
        run: pytest

  windows-smoke:
    name: Windows smoke (install + entrypoint)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install
        run: |
          python -m pip install -U pip
          pip install -e .

      - name: Smoke test CLI import/entrypoint
        run: |
          python -c "import devr; import devr.cli; print('OK')"
          devr --help

  package-smoke:
    name: Package smoke (build + wheel install)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Build package artifacts
        run: |
          python -m pip install -U pip build
          python -m build

      - name: Install wheel artifact
        run: python -m pip install --force-reinstall dist/*.whl

      - name: Smoke test installed artifact entrypoints
        run: |
          devr --version
          python -m devr --version

  docs:
    name: Docs build (sphinx)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Skip if no docs/
        shell: bash
        run: |
          if [ ! -d "docs" ]; then
            echo "No docs/ directory; skipping."
            exit 0
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e .[docs]

      - name: Build docs
        run: sphinx-build -b html docs docs/_build/html
